---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout
  title="Generator faktury testowej KSeF (sandbox)"
  description="Mini aplikacja do generowania testowej faktury w XML (FA(2)) na podstawie podanych danych."
>
  <section class="mb-16 mt-12 md:mb-24 md:mt-16">
    <div class="grid gap-10 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
      <div class="rounded-2xl border border-[var(--border)] bg-white p-6 shadow-sm">
        <h2 class="text-xl font-semibold text-gray-900">Dane faktury</h2>
        <p class="mt-2 text-sm text-gray-600">
          Generator tworzy plik XML w formacie FA(2) do testow sandbox. XML nie jest walidowany po stronie aplikacji.
        </p>

        <form id="ksef-form" class="mt-6 space-y-6">
          <div class="grid gap-4 md:grid-cols-2">
            <label class="block text-sm font-medium text-gray-700">
              Numer faktury
              <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="invoiceNumber" required />
            </label>
            <label class="block text-sm font-medium text-gray-700">
              Data wystawienia
              <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" type="date" name="issueDate" required />
            </label>
            <label class="block text-sm font-medium text-gray-700">
              Data sprzedazy
              <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" type="date" name="saleDate" required />
            </label>
          </div>

          <div class="grid gap-4 md:grid-cols-2">
            <div class="rounded-xl border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Sprzedawca</h3>
              <label class="mt-3 block text-sm text-gray-700">
                Nazwa
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="sellerName" required />
              </label>
              <label class="mt-3 block text-sm text-gray-700">
                NIP
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="sellerNip" required />
              </label>
              <label class="mt-3 block text-sm text-gray-700">
                Adres
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="sellerAddress" required />
              </label>
            </div>

            <div class="rounded-xl border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Nabywca</h3>
              <label class="mt-3 block text-sm text-gray-700">
                Nazwa
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="buyerName" required />
              </label>
              <label class="mt-3 block text-sm text-gray-700">
                NIP
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="buyerNip" required />
              </label>
            </div>
          </div>

          <div class="rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-gray-800">Pozycje</h3>
              <button
                type="button"
                class="rounded-full border border-[var(--accent)] px-4 py-1 text-xs font-semibold text-[var(--accent)]"
                id="add-item"
              >
                Dodaj pozycje
              </button>
            </div>

            <div id="items" class="mt-4 space-y-4"></div>
          </div>

          <div class="flex flex-wrap gap-3">
            <button
              type="button"
              id="generate-xml"
              class="rounded-full bg-[var(--accent)] px-6 py-2 text-sm font-semibold text-white"
            >
              Generuj XML
            </button>
            <button
              type="button"
              id="download-xml"
              class="rounded-full border border-gray-300 px-6 py-2 text-sm font-semibold text-gray-700"
              disabled
            >
              Pobierz XML
            </button>
          </div>
        </form>
      </div>

      <div class="rounded-2xl border border-[var(--border)] bg-gray-50 p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-gray-900">Podglad XML (FA(2))</h2>
          <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-gray-500">Sandbox</span>
        </div>
        <p class="mt-2 text-sm text-gray-600">
          Skopiuj lub pobierz wygenerowany plik XML. W razie potrzeby dostosuj do pelnej walidacji XSD.
        </p>
        <textarea
          id="xml-output"
          class="mt-4 h-[560px] w-full resize-none rounded-xl border border-gray-200 bg-white p-4 text-xs font-mono"
          readonly
        ></textarea>
      </div>
    </div>
  </section>
</BaseLayout>

<script is:inline type="module">
  const form = document.getElementById("ksef-form");
  const itemsContainer = document.getElementById("items");
  const addItemBtn = document.getElementById("add-item");
  const generateBtn = document.getElementById("generate-xml");
  const downloadBtn = document.getElementById("download-xml");
  const output = document.getElementById("xml-output");

  const defaultItem = () => ({
    name: "",
    qty: "1",
    unitNet: "",
    vatRate: "23",
  });

  const toNumber = (value) => {
    const num = Number(String(value).replace(",", "."));
    return Number.isFinite(num) ? num : 0;
  };

  const formatMoney = (value) => {
    return value.toFixed(2);
  };

  const createItemRow = (data) => {
    const wrapper = document.createElement("div");
    wrapper.className = "grid gap-3 rounded-lg border border-gray-200 p-3 md:grid-cols-[1.3fr_0.5fr_0.6fr_0.6fr_auto]";
    wrapper.innerHTML = `
      <input class="rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemName" placeholder="Nazwa pozycji" value="${data.name}" required />
      <input class="rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemQty" placeholder="Ilosc" value="${data.qty}" />
      <input class="rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemUnitNet" placeholder="Cena netto" value="${data.unitNet}" />
      <select class="rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemVatRate">
        <option value="23">23%</option>
        <option value="8">8%</option>
        <option value="5">5%</option>
        <option value="0">0%</option>
        <option value="zw">ZW</option>
      </select>
      <button type="button" class="text-xs font-semibold text-red-600 remove-item">Usun</button>
    `;
    const select = wrapper.querySelector("select");
    select.value = data.vatRate;
    wrapper.querySelector(".remove-item").addEventListener("click", () => wrapper.remove());
    return wrapper;
  };

  const getItems = () => {
    const rows = Array.from(itemsContainer.querySelectorAll("div"));
    return rows.map((row, index) => {
      const name = row.querySelector('[name="itemName"]').value.trim();
      const qty = toNumber(row.querySelector('[name="itemQty"]').value || 0);
      const unitNet = toNumber(row.querySelector('[name="itemUnitNet"]').value || 0);
      const vatRateRaw = row.querySelector('[name="itemVatRate"]').value;
      const vatRate = vatRateRaw === "zw" ? 0 : toNumber(vatRateRaw);
      const net = qty * unitNet;
      const vat = net * (vatRate / 100);
      const gross = net + vat;

      return {
        index: index + 1,
        name,
        qty,
        unitNet,
        vatRate: vatRateRaw,
        net,
        vat,
        gross,
      };
    });
  };

  const escapeXml = (value) => {
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&apos;");
  };

  const buildXml = (data) => {
    const itemsXml = data.items
      .map(
        (item) => `
    <Pozycja>
      <Lp>${item.index}</Lp>
      <Nazwa>${escapeXml(item.name)}</Nazwa>
      <Ilosc>${formatMoney(item.qty)}</Ilosc>
      <CenaNetto>${formatMoney(item.unitNet)}</CenaNetto>
      <StawkaVAT>${item.vatRate}</StawkaVAT>
      <WartoscNetto>${formatMoney(item.net)}</WartoscNetto>
      <KwotaVAT>${formatMoney(item.vat)}</KwotaVAT>
      <WartoscBrutto>${formatMoney(item.gross)}</WartoscBrutto>
    </Pozycja>`
      )
      .join("");

    return `<?xml version="1.0" encoding="UTF-8"?>
<FakturaFA2 xmlns="http://ksef.mf.gov.pl/schema/FA2">
  <Naglowek>
    <NumerFaktury>${escapeXml(data.invoiceNumber)}</NumerFaktury>
    <DataWystawienia>${escapeXml(data.issueDate)}</DataWystawienia>
    <DataSprzedazy>${escapeXml(data.saleDate)}</DataSprzedazy>
  </Naglowek>
  <Sprzedawca>
    <Nazwa>${escapeXml(data.sellerName)}</Nazwa>
    <NIP>${escapeXml(data.sellerNip)}</NIP>
    <Adres>${escapeXml(data.sellerAddress)}</Adres>
  </Sprzedawca>
  <Nabywca>
    <Nazwa>${escapeXml(data.buyerName)}</Nazwa>
    <NIP>${escapeXml(data.buyerNip)}</NIP>
  </Nabywca>
  <Pozycje>${itemsXml}
  </Pozycje>
  <Podsumowanie>
    <RazemNetto>${formatMoney(data.summary.net)}</RazemNetto>
    <RazemVAT>${formatMoney(data.summary.vat)}</RazemVAT>
    <RazemBrutto>${formatMoney(data.summary.gross)}</RazemBrutto>
  </Podsumowanie>
</FakturaFA2>`;
  };

  const collectFormData = () => {
    const formData = new FormData(form);
    const items = getItems().filter((item) => item.name);
    const summary = items.reduce(
      (acc, item) => {
        acc.net += item.net;
        acc.vat += item.vat;
        acc.gross += item.gross;
        return acc;
      },
      { net: 0, vat: 0, gross: 0 }
    );

    return {
      invoiceNumber: formData.get("invoiceNumber") || "",
      issueDate: formData.get("issueDate") || "",
      saleDate: formData.get("saleDate") || "",
      sellerName: formData.get("sellerName") || "",
      sellerNip: formData.get("sellerNip") || "",
      sellerAddress: formData.get("sellerAddress") || "",
      buyerName: formData.get("buyerName") || "",
      buyerNip: formData.get("buyerNip") || "",
      items,
      summary,
    };
  };

  const setOutput = (xml) => {
    output.value = xml;
    downloadBtn.disabled = !xml;
  };

  const handleGenerate = () => {
    if (!form.reportValidity()) return;
    const data = collectFormData();
    if (!data.items.length) {
      setOutput("");
      return;
    }
    const xml = buildXml(data);
    setOutput(xml);
  };

  const handleDownload = () => {
    if (!output.value) return;
    const blob = new Blob([output.value], { type: "application/xml" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "ksef-fa2-test.xml";
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
  };

  addItemBtn.addEventListener("click", () => itemsContainer.appendChild(createItemRow(defaultItem())));
  generateBtn.addEventListener("click", handleGenerate);
  downloadBtn.addEventListener("click", handleDownload);

  itemsContainer.appendChild(createItemRow(defaultItem()));
</script>
