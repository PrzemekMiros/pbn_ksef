---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout
  title="Generator faktury testowej KSeF"
  description="Mini aplikacja do generowania testowej faktury w XML (FA(2)) na podstawie podanych danych."
>
  <section class="mb-16 mt-12 md:mb-24 md:mt-16">
    <div class="grid gap-10 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
      <div class="rounded-2xl border border-[var(--border)] bg-white p-6 shadow-sm">
        <h2 class="text-xl font-semibold text-gray-900">Dane faktury</h2>
        <p class="mt-2 text-sm text-gray-600">
          Generator tworzy plik XML w formacie FA(2) do testow sandbox. XML nie jest walidowany po stronie aplikacji.
        </p>

        <form id="ksef-form" class="mt-6 space-y-6">
          <div class="grid gap-4 md:grid-cols-2">
            <label class="block text-sm font-medium text-gray-700">
              Numer faktury
              <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="invoiceNumber" required />
            </label>
            <label class="block text-sm font-medium text-gray-700">
              Data wystawienia
              <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" type="date" name="issueDate" required />
            </label>
            <label class="block text-sm font-medium text-gray-700">
              Data sprzedazy
              <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" type="date" name="saleDate" required />
            </label>
          </div>

          <div class="grid gap-4 md:grid-cols-2">
            <div class="rounded-xl border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Sprzedawca</h3>
              <label class="mt-3 block text-sm text-gray-700">
                Nazwa
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="sellerName" required />
              </label>
              <label class="mt-3 block text-sm text-gray-700">
                NIP
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="sellerNip" required />
              </label>
              <label class="mt-3 block text-sm text-gray-700">
                Adres
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="sellerAddress" required />
              </label>
            </div>

            <div class="rounded-xl border border-gray-200 p-4">
              <h3 class="text-sm font-semibold text-gray-800">Nabywca</h3>
              <label class="mt-3 block text-sm text-gray-700">
                Nazwa
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="buyerName" required />
              </label>
              <label class="mt-3 block text-sm text-gray-700">
                NIP
                <input class="mt-2 w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="buyerNip" required />
              </label>
            </div>
          </div>

          <div class="rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-gray-800">Pozycje</h3>
              <button
                type="button"
                class="rounded-full border border-[var(--accent)] px-4 py-1 text-xs font-semibold text-[var(--accent)]"
                id="add-item"
              >
                Dodaj pozycje
              </button>
            </div>

            <div id="items" class="mt-4 space-y-4"></div>
          </div>

          <div class="flex flex-wrap gap-3">
            <button
              type="button"
              id="generate-xml"
              class="rounded-full bg-[var(--accent)] px-6 py-2 text-sm font-semibold text-white"
            >
              Generuj XML
            </button>
            <button
              type="button"
              id="preview-pdf"
              class="rounded-full border border-[var(--accent)] px-6 py-2 text-sm font-semibold text-[var(--accent)]"
              disabled
            >
              Podglad PDF
            </button>
            <button
              type="button"
              id="download-xml"
              class="rounded-full border border-gray-300 px-6 py-2 text-sm font-semibold text-gray-700"
              disabled
            >
              Pobierz XML
            </button>
          </div>
        </form>
      </div>

      <div class="rounded-2xl border border-[var(--border)] bg-gray-50 p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-gray-900">Podglad XML (FA(2))</h2>
          <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-gray-500">Sandbox</span>
        </div>
        <p class="mt-2 text-sm text-gray-600">
          Skopiuj lub pobierz wygenerowany plik XML. W razie potrzeby dostosuj do pelnej walidacji XSD.
        </p>
        <textarea
          id="xml-output"
          class="mt-4 h-[560px] w-full resize-none rounded-xl border border-gray-200 bg-white p-4 text-xs font-mono"
          readonly
        ></textarea>
      </div>
    </div>
  </section>

  <div
    id="pdf-modal"
    class="fixed inset-0 z-500 hidden flex items-center justify-center bg-black/50 p-4"
    aria-hidden="true"
    role="dialog"
    aria-modal="true"
  >
    <div class="w-full max-w-3xl rounded-2xl bg-white p-6 shadow-xl">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Podglad PDF</h3>
        <button
          type="button"
          id="close-pdf"
          class="rounded-full border border-gray-200 px-3 py-1 text-xs font-semibold text-gray-600"
        >
          Zamknij
        </button>
      </div>
      <p class="mt-2 text-sm text-gray-600">
        Ten podglad jest generowany z XML. Wybierz "Pobierz PDF", aby zapisac plik z poziomu okna drukowania.
      </p>
      <div class="mt-4 max-h-[70vh] overflow-auto rounded-xl border border-gray-200 bg-gray-50 p-4">
        <div id="pdf-preview" class="rounded-lg bg-white p-6 shadow-sm"></div>
      </div>
      <div class="mt-5 flex flex-wrap justify-end gap-3">
        <button
          type="button"
          id="download-pdf"
          class="rounded-full bg-[var(--accent)] px-6 py-2 text-sm font-semibold text-white"
        >
          Pobierz PDF
        </button>
      </div>
    </div>
  </div>
</BaseLayout>

<style is:inline>
  .pdf-preview h1 {
    font-family: "Times New Roman", serif;
    font-size: 20px;
    margin: 0 0 12px;
    color: #111827;
  }
  .pdf-preview h2 {
    font-family: "Times New Roman", serif;
    font-size: 14px;
    margin: 0 0 6px;
    color: #111827;
  }
  .pdf-preview .meta {
    font-size: 12px;
    color: #111827;
    margin-bottom: 12px;
  }
  .pdf-preview .grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }
  .pdf-preview .box {
    border: 1px solid #e5e7eb;
    padding: 10px;
  }
  .pdf-preview table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-top: 12px;
  }
  .pdf-preview th,
  .pdf-preview td {
    border: 1px solid #e5e7eb;
    padding: 6px;
    text-align: left;
  }
  .pdf-preview th {
    background: #f9fafb;
    font-weight: 600;
  }
  .pdf-preview .right {
    text-align: right;
  }
  .pdf-preview .summary {
    margin-top: 12px;
    display: grid;
    gap: 6px;
  }
  .pdf-preview .summary div {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
  }
  .pdf-preview .muted {
    color: #6b7280;
    font-size: 11px;
  }
  @media (max-width: 768px) {
    .pdf-preview .grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline type="module">
  const form = document.getElementById("ksef-form");
  const itemsContainer = document.getElementById("items");
  const addItemBtn = document.getElementById("add-item");
  const generateBtn = document.getElementById("generate-xml");
  const previewBtn = document.getElementById("preview-pdf");
  const downloadBtn = document.getElementById("download-xml");
  const output = document.getElementById("xml-output");
  const pdfModal = document.getElementById("pdf-modal");
  const pdfPreview = document.getElementById("pdf-preview");
  const closePdfBtn = document.getElementById("close-pdf");
  const downloadPdfBtn = document.getElementById("download-pdf");

  const defaultItem = () => ({
    name: "",
    qty: "1",
    unitNet: "",
    vatRate: "23",
  });

  const toNumber = (value) => {
    const num = Number(String(value).replace(",", "."));
    return Number.isFinite(num) ? num : 0;
  };

  const formatMoney = (value) => {
    return value.toFixed(2);
  };

  const createItemRow = (data) => {
    const wrapper = document.createElement("div");
    wrapper.className = "grid gap-3 rounded-lg border border-gray-200 p-3 md:grid-cols-[minmax(0,1.4fr)_minmax(0,0.5fr)_minmax(0,0.7fr)_minmax(0,0.6fr)_minmax(0,0.4fr)]";
    wrapper.innerHTML = `
      <input class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemName" placeholder="Nazwa pozycji" value="${data.name}" required />
      <input class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemQty" placeholder="Ilosc" value="${data.qty}" />
      <input class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemUnitNet" placeholder="Cena netto" value="${data.unitNet}" />
      <select class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm" name="itemVatRate">
        <option value="23">23%</option>
        <option value="8">8%</option>
        <option value="5">5%</option>
        <option value="0">0%</option>
        <option value="zw">ZW</option>
      </select>
      <button type="button" class="w-full text-xs font-semibold text-red-600 remove-item">Usun</button>
    `;
    const select = wrapper.querySelector("select");
    select.value = data.vatRate;
    wrapper.querySelector(".remove-item").addEventListener("click", () => wrapper.remove());
    return wrapper;
  };

  const getItems = () => {
    const rows = Array.from(itemsContainer.querySelectorAll("div"));
    return rows.map((row, index) => {
      const name = row.querySelector('[name="itemName"]').value.trim();
      const qty = toNumber(row.querySelector('[name="itemQty"]').value || 0);
      const unitNet = toNumber(row.querySelector('[name="itemUnitNet"]').value || 0);
      const vatRateRaw = row.querySelector('[name="itemVatRate"]').value;
      const vatRate = vatRateRaw === "zw" ? 0 : toNumber(vatRateRaw);
      const net = qty * unitNet;
      const vat = net * (vatRate / 100);
      const gross = net + vat;

      return {
        index: index + 1,
        name,
        qty,
        unitNet,
        vatRate: vatRateRaw,
        net,
        vat,
        gross,
      };
    });
  };

  const escapeXml = (value) => {
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&apos;");
  };

  const buildXml = (data) => {
    const itemsXml = data.items
      .map(
        (item) => `
    <Pozycja>
      <Lp>${item.index}</Lp>
      <Nazwa>${escapeXml(item.name)}</Nazwa>
      <Ilosc>${formatMoney(item.qty)}</Ilosc>
      <CenaNetto>${formatMoney(item.unitNet)}</CenaNetto>
      <StawkaVAT>${item.vatRate}</StawkaVAT>
      <WartoscNetto>${formatMoney(item.net)}</WartoscNetto>
      <KwotaVAT>${formatMoney(item.vat)}</KwotaVAT>
      <WartoscBrutto>${formatMoney(item.gross)}</WartoscBrutto>
    </Pozycja>`
      )
      .join("");

    return `<?xml version="1.0" encoding="UTF-8"?>
<FakturaFA2 xmlns="http://ksef.mf.gov.pl/schema/FA2">
  <Naglowek>
    <NumerFaktury>${escapeXml(data.invoiceNumber)}</NumerFaktury>
    <DataWystawienia>${escapeXml(data.issueDate)}</DataWystawienia>
    <DataSprzedazy>${escapeXml(data.saleDate)}</DataSprzedazy>
  </Naglowek>
  <Sprzedawca>
    <Nazwa>${escapeXml(data.sellerName)}</Nazwa>
    <NIP>${escapeXml(data.sellerNip)}</NIP>
    <Adres>${escapeXml(data.sellerAddress)}</Adres>
  </Sprzedawca>
  <Nabywca>
    <Nazwa>${escapeXml(data.buyerName)}</Nazwa>
    <NIP>${escapeXml(data.buyerNip)}</NIP>
  </Nabywca>
  <Pozycje>${itemsXml}
  </Pozycje>
  <Podsumowanie>
    <RazemNetto>${formatMoney(data.summary.net)}</RazemNetto>
    <RazemVAT>${formatMoney(data.summary.vat)}</RazemVAT>
    <RazemBrutto>${formatMoney(data.summary.gross)}</RazemBrutto>
  </Podsumowanie>
</FakturaFA2>`;
  };

  const collectFormData = () => {
    const formData = new FormData(form);
    const items = getItems().filter((item) => item.name);
    const summary = items.reduce(
      (acc, item) => {
        acc.net += item.net;
        acc.vat += item.vat;
        acc.gross += item.gross;
        return acc;
      },
      { net: 0, vat: 0, gross: 0 }
    );

    return {
      invoiceNumber: formData.get("invoiceNumber") || "",
      issueDate: formData.get("issueDate") || "",
      saleDate: formData.get("saleDate") || "",
      sellerName: formData.get("sellerName") || "",
      sellerNip: formData.get("sellerNip") || "",
      sellerAddress: formData.get("sellerAddress") || "",
      buyerName: formData.get("buyerName") || "",
      buyerNip: formData.get("buyerNip") || "",
      items,
      summary,
    };
  };

  const setOutput = (xml) => {
    output.value = xml;
    downloadBtn.disabled = !xml;
    previewBtn.disabled = !xml;
  };

  const handleGenerate = () => {
    if (!form.reportValidity()) return;
    const data = collectFormData();
    if (!data.items.length) {
      setOutput("");
      return;
    }
    const xml = buildXml(data);
    setOutput(xml);
  };

  const handleDownload = () => {
    if (!output.value) return;
    const blob = new Blob([output.value], { type: "application/xml" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "ksef-fa2-test.xml";
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
  };

  const buildPdfHtml = (xml) => {
    const invoiceHtml = buildInvoiceHtml(xml, true);
    return `<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <title>Podglad XML - PDF</title>
    <style>
      @page { margin: 18mm; }
      body { font-family: "Times New Roman", serif; color: #111827; }
      h1 { font-size: 18px; margin: 0 0 16px; }
      h2 { font-size: 14px; margin: 0 0 8px; }
      .meta { font-size: 12px; margin-bottom: 16px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .box { border: 1px solid #e5e7eb; padding: 10px; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 12px; }
      th, td { border: 1px solid #e5e7eb; padding: 6px; text-align: left; }
      th { background: #f9fafb; }
      .right { text-align: right; }
      .summary { margin-top: 12px; width: 100%; display: grid; gap: 6px; }
      .summary div { display: flex; justify-content: space-between; font-size: 12px; }
      .muted { color: #6b7280; font-size: 11px; }
    </style>
  </head>
  <body>
    ${invoiceHtml}
  </body>
</html>`;
  };

  const getXmlText = (node, selector) => {
    const el = node.querySelector(selector);
    return el ? el.textContent || "" : "";
  };

  const buildInvoiceHtml = (xml, forPrint = false) => {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xml, "application/xml");
    const hasError = xmlDoc.querySelector("parsererror");
    if (hasError) {
      const errorText = escapeXml(hasError.textContent || "Nieprawidlowy XML");
      return `<div class="muted">Nie mozna zbudowac podgladu: ${errorText}</div>`;
    }

    const faktura = xmlDoc.querySelector("FakturaFA2");
    if (!faktura) {
      return `<div class="muted">Brak danych do podgladu.</div>`;
    }

    const invoiceNumber = getXmlText(faktura, "NumerFaktury");
    const issueDate = getXmlText(faktura, "DataWystawienia");
    const saleDate = getXmlText(faktura, "DataSprzedazy");
    const sellerName = getXmlText(faktura, "Sprzedawca > Nazwa");
    const sellerNip = getXmlText(faktura, "Sprzedawca > NIP");
    const sellerAddress = getXmlText(faktura, "Sprzedawca > Adres");
    const buyerName = getXmlText(faktura, "Nabywca > Nazwa");
    const buyerNip = getXmlText(faktura, "Nabywca > NIP");

    const positions = Array.from(faktura.querySelectorAll("Pozycje > Pozycja")).map((pos) => ({
      lp: getXmlText(pos, "Lp"),
      name: getXmlText(pos, "Nazwa"),
      qty: getXmlText(pos, "Ilosc"),
      unitNet: getXmlText(pos, "CenaNetto"),
      vatRate: getXmlText(pos, "StawkaVAT"),
      net: getXmlText(pos, "WartoscNetto"),
      vat: getXmlText(pos, "KwotaVAT"),
      gross: getXmlText(pos, "WartoscBrutto"),
    }));

    const totalNet = getXmlText(faktura, "Podsumowanie > RazemNetto");
    const totalVat = getXmlText(faktura, "Podsumowanie > RazemVAT");
    const totalGross = getXmlText(faktura, "Podsumowanie > RazemBrutto");

    const rowsHtml = positions
      .map(
        (row) => `
        <tr>
          <td>${escapeXml(row.lp)}</td>
          <td>${escapeXml(row.name)}</td>
          <td class="right">${escapeXml(row.qty)}</td>
          <td class="right">${escapeXml(row.unitNet)}</td>
          <td class="right">${escapeXml(row.vatRate)}</td>
          <td class="right">${escapeXml(row.net)}</td>
          <td class="right">${escapeXml(row.vat)}</td>
          <td class="right">${escapeXml(row.gross)}</td>
        </tr>`
      )
      .join("");

    const wrapperClass = forPrint ? "pdf-preview" : "pdf-preview";
    return `
      <div class="${wrapperClass}">
        <h1>Faktura VAT</h1>
        <div class="meta">
          Numer: <strong>${escapeXml(invoiceNumber)}</strong><br />
          Data wystawienia: ${escapeXml(issueDate)}<br />
          Data sprzedazy: ${escapeXml(saleDate)}
        </div>
        <div class="grid">
          <div class="box">
            <h2>Sprzedawca</h2>
            <div>${escapeXml(sellerName)}</div>
            <div>NIP: ${escapeXml(sellerNip)}</div>
            <div>${escapeXml(sellerAddress)}</div>
          </div>
          <div class="box">
            <h2>Nabywca</h2>
            <div>${escapeXml(buyerName)}</div>
            <div>NIP: ${escapeXml(buyerNip)}</div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Lp</th>
              <th>Nazwa</th>
              <th class="right">Ilosc</th>
              <th class="right">Cena netto</th>
              <th class="right">VAT</th>
              <th class="right">Wartosc netto</th>
              <th class="right">Kwota VAT</th>
              <th class="right">Wartosc brutto</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml || `<tr><td colspan="8" class="muted">Brak pozycji</td></tr>`}
          </tbody>
        </table>
        <div class="summary">
          <div><span>Razem netto</span><strong>${escapeXml(totalNet)}</strong></div>
          <div><span>Razem VAT</span><strong>${escapeXml(totalVat)}</strong></div>
          <div><span>Razem brutto</span><strong>${escapeXml(totalGross)}</strong></div>
        </div>
      </div>
    `;
  };

  const openPdfModal = () => {
    if (!output.value) return;
    pdfPreview.innerHTML = buildInvoiceHtml(output.value);
    pdfModal.classList.remove("hidden");
    pdfModal.setAttribute("aria-hidden", "false");
    document.body.classList.add("overflow-hidden");
  };

  const closePdfModal = () => {
    pdfModal.classList.add("hidden");
    pdfModal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("overflow-hidden");
  };

  const handleDownloadPdf = () => {
    if (!output.value) return;
    const win = window.open("", "_blank");
    if (!win) return;
    win.document.open();
    win.document.write(buildPdfHtml(output.value));
    win.document.close();
    win.focus();
    setTimeout(() => {
      win.print();
      win.close();
    }, 150);
  };

  addItemBtn.addEventListener("click", () => itemsContainer.appendChild(createItemRow(defaultItem())));
  generateBtn.addEventListener("click", handleGenerate);
  downloadBtn.addEventListener("click", handleDownload);
  previewBtn.addEventListener("click", openPdfModal);
  closePdfBtn.addEventListener("click", closePdfModal);
  pdfModal.addEventListener("click", (event) => {
    if (event.target === pdfModal) closePdfModal();
  });
  downloadPdfBtn.addEventListener("click", handleDownloadPdf);

  itemsContainer.appendChild(createItemRow(defaultItem()));
</script>
